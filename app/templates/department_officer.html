{% extends "base.html" %}

{% block title %}لوحة تحكم مسؤول القسم - {{ current_user.username }}{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h3>قسم: {{ current_user.username }}</h3>

    <!-- قسم الإشعارات (مشابه للطالب) -->
    <div class="d-flex align-items-center">
        <div class="dropdown d-inline-block ms-3">
            <button class="btn btn-light position-relative" type="button" id="notificationDropdown"
                data-bs-toggle="dropdown" aria-expanded="false">
                <i class="bi bi-bell fs-5"></i> <!-- أيقونة الجرس -->
                {% set unread = current_user.notifications|selectattr('is_read','equalto',False)|list|length %}
                {% if unread > 0 %}
                <span
                    class="badge bg-danger rounded-pill position-absolute top-0 start-100 translate-middle notification-count">{{
                    unread }}</span>
                {% endif %}
            </button>
            <ul class="dropdown-menu dropdown-menu-end shadow border-0 notification-dropdown-menu"
                aria-labelledby="notificationDropdown">
                {% for n in current_user.notifications|sort(attribute='timestamp', reverse=True) %}
                <li class="dropdown-item border-bottom py-2 {% if not n.is_read %}fw-bold{% endif %}">
                    <small>{{ n.message }}</small><br>
                    <small class="text-muted notification-time">{{ n.timestamp | local_time }}</small>
                </li>
                {% else %}
                <li class="dropdown-item text-muted text-center py-3">لا توجد إشعارات</li>
                {% endfor %}
                {% if current_user.notifications %}
                <li>
                    <hr class="dropdown-divider my-1">
                </li>
                <li>
                    <a class="dropdown-item text-center text-primary py-2"
                        href="{{ url_for('main.mark_notifications_read') }}">
                        <small>وضع علامة مقروءة على الكل</small>
                    </a>
                </li>
                {% endif %}
            </ul>
        </div>
    </div>

</div>

<!-- عرض الرسائل التنبيهية -->
{% with messages = get_flashed_messages(with_categories=true) %}
{% if messages %}
{% for category, message in messages %}
<div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
    {{ message }}
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
</div>
{% endfor %}
{% endif %}
{% endwith %}

<!-- جدول الطلبات الواردة -->
<div class="card mt-3 border-0 shadow-sm">
    <div class="card-header bg-white py-3">
        <h5 class="card-title mb-0 fw-bold">
            <i class="bi bi-list-task me-2"></i>طلبات براءة الذمة
        </h5>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-striped align-middle text-center mb-0">
                <thead class="bg-light">
                    <tr>
                        <th class="py-3">الرقم الجامعي</th>
                        <th class="py-3">اسم الطالب</th>
                        <th class="py-3">القسم / المرحلة / الدراسة</th>
                        <th class="py-3">الإجراء</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- حلقة تكرار لعرض كل طلب وارد للقسم -->
                    {% for record in records %}
                    <tr>
                        <td>{{ record.student.university_id }}</td>
                        <td>{{ record.student.full_name or record.student.username }}</td>
                        <td>
                            <small class="d-block text-muted">القسم: {{ record.student.department or '-' }}</small>
                            <small class="d-block text-muted">المرحلة: {{ record.student.stage or '-' }}</small>
                            <small class="d-block text-muted">الدراسة: {{ record.student.study_type or '-' }}</small>
                        </td>
                        <td>
                            <!-- نموذج تحديث الحالة لكل طالب -->
                            <form action="{{ url_for('main.update_status') }}" method="POST"
                                class="d-flex justify-content-center align-items-center flex-wrap gap-2">
                                {{ form.csrf_token }} <!-- حماية CSRF -->
                                <input type="hidden" name="student_id" value="{{ record.student_id }}">
                                <input type="hidden" name="department" value="{{ record.department }}">
                                <label class="visually-hidden" for="status-{{ record.student_id }}">حالة الطلب</label>

                                <!-- القائمة المنسدلة لاختيار الحالة -->
                                <select name="status" id="status-{{ record.student_id }}"
                                    class="form-select form-select-sm w-auto" required aria-label="حالة الطلب">
                                    <option value="pending" {% if record.status=='pending' %}selected{% endif %}>قيد
                                        الانتظار</option>
                                    <option value="approved" {% if record.status=='approved' %}selected{% endif %}>موافق
                                        عليه</option>
                                    <option value="rejected" {% if record.status=='rejected' %}selected{% endif %}>مرفوض
                                    </option>
                                </select>

                                <!-- حقل الملاحظات الاختياري -->
                                <input type="text" name="comment" class="form-control form-control-sm min-width-150"
                                    placeholder="إضافة ملاحظة (اختياري)" value="{{ record.comment or '' }}">

                                <button type="submit" class="btn btn-sm btn-primary">حفظ</button>
                            </form>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="4" class="text-center text-muted py-5">
                            <i class="bi bi-inbox fs-1 d-block mb-3 text-secondary opacity-50"></i>
                            <h5 class="fw-light">لا توجد طلبات حالياً</h5>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- إعدادات الإشعارات -->
<div class="card mt-4 border-0 shadow-sm">
    <div class="card-header bg-white py-3">
        <h5 class="card-title fw-bold">
            <i class="bi bi-bell-fill me-2"></i>إعدادات الإشعارات الفورية
        </h5>
    </div>
    <div class="card-body p-4">
        <p class="text-muted mb-4">قم بتفعيل الإشعارات ليصلك إشعار فوري على جهازك عند تقديم طالب جديد لطلب براءة ذمة
            لقسمك.</p>
        <div class="d-flex gap-3">
            <button id="enable-notifications" class="btn btn-outline-primary px-4"
                data-vapid-key="{{ vapid_public_key }}">
                <i class="bi bi-bell me-2"></i> تفعيل الإشعارات
            </button>
            <button id="disable-notifications" class="btn btn-outline-danger px-4">
                <i class="bi bi-bell-slash me-2"></i> إلغاء التفعيل
            </button>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/push-subscription.js') }}"></script>
{% endblock %}